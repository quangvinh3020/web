<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản trị website - Admin</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Admin Common CSS -->
  <link href="css/admin-common.css" rel="stylesheet">
  <style>
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .stats-card .icon {
      font-size: 3rem;
      opacity: 0.8;
    }
    
    .form-control {
      border-radius: 8px;
      border: 1px solid #e9ecef;
      padding: 12px 15px;
    }
    
    .form-control:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="admin.html" class="logo">
      <h3 class="text-white mb-0 fw-bold">
        <i class="bi bi-code-slash me-2"></i>
        WUANG VINH
      </h3>
      <small class="text-white-50">ADMIN PANEL</small>
    </a>
    <a href="quanlidanhmuc.html">
      <i class="bi bi-list-ul me-2"></i>Quản lí danh mục
    </a>
    <a href="src.html">
      <i class="bi bi-file-earmark-code me-2"></i>Mã Nguồn
    </a>
    <a href="atm.html">
      <i class="bi bi-bank me-2"></i>Ngân hàng
    </a>
    <a href="customer.html">
      <i class="bi bi-people me-2"></i>Khách hàng
    </a>
    <a href="lichsunap.html">
      <i class="bi bi-clock-history me-2"></i>Lịch sử nạp tiền
    </a>
    <a href="baiviet.html">
      <i class="bi bi-file-text me-2"></i>Bài Viết
    </a>
    <a href="settingadmin.html" class="active">
      <i class="bi bi-gear me-2"></i>Cấu hình
    </a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container-fluid">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4 class="mb-0">
                <i class="bi bi-gear me-2"></i>Quản Lý Admin
              </h4>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 class="mb-0" id="users-count">4</h3>
                <p class="mb-0">Tổng Users</p>
              </div>
              <div class="icon">
                <i class="bi bi-people"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 class="mb-0" id="products-count">5</h3>
                <p class="mb-0">Sản Phẩm</p>
              </div>
              <div class="icon">
                <i class="bi bi-box"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 class="mb-0" id="revenue-amount">2M</h3>
                <p class="mb-0">Doanh Thu</p>
              </div>
              <div class="icon">
                <i class="bi bi-currency-dollar"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 class="mb-0" id="orders-count">6</h3>
                <p class="mb-0">Đơn Hàng</p>
              </div>
              <div class="icon">
                <i class="bi bi-cart"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Settings -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-person-gear me-2"></i>Cài Đặt Tài Khoản
              </h5>
            </div>
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <label for="adminUsername" class="form-label">Tên đăng nhập</label>
                  <input type="text" class="form-control" id="adminUsername" value="admin" readonly>
                </div>
                <div class="mb-3">
                  <label for="adminEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="adminEmail" value="admin@wuangvinh.id.vn">
                </div>
                <div class="mb-3">
                  <label for="adminPassword" class="form-label">Mật khẩu mới</label>
                  <input type="password" class="form-control" id="adminPassword" placeholder="Nhập mật khẩu mới">
                </div>
                <div class="mb-3">
                  <label for="adminConfirmPassword" class="form-label">Xác nhận mật khẩu</label>
                  <input type="password" class="form-control" id="adminConfirmPassword" placeholder="Nhập lại mật khẩu">
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check-circle me-2"></i>Cập Nhật
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-shield-check me-2"></i>Bảo Mật
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Xác thực 2 yếu tố</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                  <label class="form-check-label" for="twoFactorAuth">Bật xác thực 2 yếu tố</label>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Thông báo email</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                  <label class="form-check-label" for="emailNotifications">Nhận thông báo qua email</label>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Đăng nhập từ thiết bị mới</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="newDeviceLogin" checked>
                  <label class="form-check-label" for="newDeviceLogin">Yêu cầu xác thực</label>
                </div>
              </div>
              <button class="btn btn-outline-danger">
                <i class="bi bi-box-arrow-right me-2"></i>Đăng Xuất Tất Cả
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- System Info -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>Thông Tin Hệ Thống
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Phiên bản:</strong> 1.1.0</p>
                  <p><strong>Database:</strong> MongoDB</p>
                  <p><strong>Backend:</strong> Python Flask</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Uptime:</strong> 99.9%</p>
                  <p><strong>Bảo mật:</strong> SSL/TLS</p>
                  <p><strong>Backup:</strong> Hàng ngày</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Kiểm tra phân quyền người dùng
    if (!localStorage.getItem("token") || localStorage.getItem("role") !== "Admin") {
      window.location.href = "login.html";
    }

    // Đăng xuất
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("username");
      localStorage.removeItem("role");
      window.location.href = "login.html";
    }

    // Script để cập nhật thống kê thực từ database
    async function updateStats() {
      try {
        // Lấy thống kê từ API
        const response = await fetch('http://localhost:5000/api/stats', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const stats = await response.json();
          
          // Cập nhật các số liệu
          document.getElementById('users-count').textContent = stats.users_count;
          document.getElementById('products-count').textContent = stats.products_count;
          document.getElementById('revenue-amount').textContent = formatCurrency(stats.total_revenue);
          document.getElementById('orders-count').textContent = stats.completed_orders_count;
          
          console.log('Thống kê đã được cập nhật:', stats);
        } else {
          console.error('Lỗi khi lấy thống kê:', response.status);
        }
      } catch (error) {
        console.error('Lỗi kết nối:', error);
      }
    }

    // Format tiền tệ
    function formatCurrency(amount) {
      if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'M';
      } else if (amount >= 1000) {
        return (amount / 1000).toFixed(0) + 'K';
      }
      return amount.toString();
    }

    // Cập nhật thống kê khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      updateStats();
      
      // Cập nhật mỗi 30 giây
      setInterval(updateStats, 30000);
    });

    // Debug function
    async function debugStats() {
      console.log("🔍 Debugging stats API...");
      
      const token = localStorage.getItem('token');
      console.log("Token:", token ? "Có" : "Không");
      
      if (!token) {
        console.error("❌ Không có token, cần đăng nhập");
        return;
      }
      
      try {
        const response = await fetch('http://localhost:5000/api/stats', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log("Response status:", response.status);
        
        if (response.ok) {
          const stats = await response.json();
          console.log("✅ Stats data:", stats);
          
          // Cập nhật UI
          document.getElementById('users-count').textContent = stats.users_count;
          document.getElementById('products-count').textContent = stats.products_count;
          document.getElementById('revenue-amount').textContent = formatCurrency(stats.total_revenue);
          document.getElementById('orders-count').textContent = stats.completed_orders_count;
          
          console.log("✅ UI updated successfully");
        } else {
          const errorText = await response.text();
          console.error("❌ API Error:", response.status, errorText);
        }
      } catch (error) {
        console.error("❌ Network Error:", error);
      }
    }

    // Thêm button debug
    document.addEventListener('DOMContentLoaded', function() {
      const debugButton = document.createElement('button');
      debugButton.textContent = 'Debug Stats';
      debugButton.className = 'btn btn-warning btn-sm';
      debugButton.onclick = debugStats;
      debugButton.style.position = 'fixed';
      debugButton.style.top = '10px';
      debugButton.style.right = '10px';
      debugButton.style.zIndex = '9999';
      document.body.appendChild(debugButton);
    });
  </script>
</body>
</html>
