<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản Lý Bài Viết</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Admin Common CSS -->
  <link href="css/admin-common.css" rel="stylesheet">
  <style>
    /* Custom styles specific to this page */
    .article-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    /* Ngăn chặn modal đóng khi click bên trong */
    .modal-content {
      pointer-events: auto;
    }
    
    .modal-content * {
      pointer-events: auto;
    }
    
    .article-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .article-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #4f46e5;
      margin-bottom: 10px;
    }
    
    .article-meta {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }
    
    .article-content {
      color: #333;
      line-height: 1.6;
    }
    
    .article-actions {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-edit, .btn-delete {
      padding: 6px 12px;
      border-radius: 5px;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-edit {
      background: #007bff;
      color: white;
    }
    
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    
    .btn-edit:hover {
      background: #0056b3;
    }
    
    .btn-delete:hover {
      background: #c82333;
    }
    
    .search-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .stats-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .stats-number {
      font-size: 2rem;
      font-weight: bold;
      color: #4f46e5;
    }
    
    .stats-label {
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="admin.html" class="logo">
      <h3 class="text-white mb-0 fw-bold">
        <i class="bi bi-code-slash me-2"></i>
        WUANG VINH
      </h3>
      <small class="text-white-50">ADMIN PANEL</small>
    </a>
    <a href="quanlidanhmuc.html">
      <i class="bi bi-list-ul me-2"></i>Quản lí danh mục
    </a>
    <a href="src.html">
      <i class="bi bi-file-earmark-code me-2"></i>Mã Nguồn
    </a>
    <a href="atm.html">
      <i class="bi bi-bank me-2"></i>Ngân hàng
    </a>
    <a href="customer.html">
      <i class="bi bi-people me-2"></i>Khách hàng
    </a>
    <a href="lichsunap.html">
      <i class="bi bi-clock-history me-2"></i>Lịch sử nạp tiền
    </a>
    <a href="baiviet.html" class="active">
      <i class="bi bi-file-text me-2"></i>Bài Viết
    </a>
    <a href="settingadmin.html">
      <i class="bi bi-gear me-2"></i>Cấu hình
    </a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Content Header -->
    <div class="content-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1><i class="bi bi-file-text text-primary me-2"></i>Quản Lý Bài Viết</h1>
          <p>Quản lý tin tức, hướng dẫn và bài viết hệ thống</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" onclick="addNewArticle()">
            <i class="bi bi-plus-circle me-2"></i>Thêm Bài Viết
          </button>
          <div class="user-dropdown">
            <div class="user-trigger" onclick="toggleDropdown()">
              <img src="img/user.png" alt="User Avatar" class="avatar">
              <span id="username">Chưa đăng nhập</span>
              <span class="arrow">▼</span>
            </div>
            <div id="dropdownMenu" class="dropdown-menu">
              <a href="#">Số dư: <span id="balance-display">0 ₫</span></a>
              <a href="#" onclick="loadTransactionHistory()">Lịch sử hoạt động</a>
              <a href="#" onclick="logout()">Đăng xuất</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stats-card text-center">
          <div class="stats-number" id="totalArticles">2</div>
          <div class="stats-label">Tổng bài viết</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card text-center">
          <div class="stats-number" id="publishedArticles">2</div>
          <div class="stats-label">Đã xuất bản</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card text-center">
          <div class="stats-number" id="draftArticles">0</div>
          <div class="stats-label">Bản nháp</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card text-center">
          <div class="stats-number" id="totalViews">156</div>
          <div class="stats-label">Lượt xem</div>
        </div>
      </div>
    </div>

    <!-- Search Container -->
    <div class="search-container">
      <div class="row">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm bài viết...">
          </div>
        </div>
        <div class="col-md-4">
          <select class="form-select" id="filterStatus">
            <option value="">Tất cả trạng thái</option>
            <option value="published">Đã xuất bản</option>
            <option value="draft">Bản nháp</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Articles List -->
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <!-- Loading -->
          <div id="loadingArticles" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-3">Đang tải danh sách bài viết...</p>
          </div>
          
          <!-- Danh sách bài viết -->
          <div id="articlesList">
            <!-- Articles will be loaded here -->
          </div>
          
          <!-- No articles message -->
          <div id="noArticles" class="text-center py-5" style="display: none;">
            <i class="bi bi-newspaper" style="font-size: 4rem; color: #ccc;"></i>
            <h4 class="mt-3 text-muted">Chưa có bài viết nào</h4>
            <p class="text-muted">Hãy thêm bài viết đầu tiên để bắt đầu!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Article Modal -->
  <div class="modal fade" id="articleModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm bài viết mới</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="articleForm">
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="articleTitle" class="form-label">
                    <i class="bi bi-type-bold"></i> Tiêu đề bài viết *
                  </label>
                  <input type="text" class="form-control" id="articleTitle" name="title" 
                         placeholder="Nhập tiêu đề bài viết..." required>
                </div>
                
                <div class="mb-3">
                  <label for="articleContent" class="form-label">
                    <i class="bi bi-file-text"></i> Nội dung bài viết *
                  </label>
                  <textarea class="form-control" id="articleContent" name="content" rows="12" 
                            placeholder="Nhập nội dung bài viết..." required></textarea>
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> Hỗ trợ Markdown: **bold**, *italic*, `code`, ## headings
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="articleSummary" class="form-label">
                    <i class="bi bi-card-text"></i> Tóm tắt
                  </label>
                  <textarea class="form-control" id="articleSummary" name="summary" rows="4" 
                            placeholder="Tóm tắt ngắn gọn về bài viết..."></textarea>
                </div>
                
                <div class="mb-3">
                  <label for="articleImage" class="form-label">
                    <i class="bi bi-image"></i> Ảnh đại diện
                  </label>
                  <div class="row">
                    <div class="col-md-8">
                      <input type="text" class="form-control" id="articleImage" name="image" 
                             placeholder="URL ảnh hoặc chọn file upload...">
                    </div>
                    <div class="col-md-4">
                      <input type="file" class="form-control" id="imageFile" accept="image/*" style="display: none;">
                      <button type="button" class="btn btn-outline-primary btn-sm w-100" id="uploadBtn">
                        <i class="bi bi-upload"></i> Upload
                      </button>
                    </div>
                  </div>
                  <div id="imagePreview" class="mt-2" style="display: none;">
                    <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="articleStatus" class="form-label">
                    <i class="bi bi-toggle-on"></i> Trạng thái
                  </label>
                  <select class="form-select" id="articleStatus" name="status">
                    <option value="published">Đã xuất bản</option>
                    <option value="draft">Bản nháp</option>
                    <option value="archived">Đã lưu trữ</option>
                  </select>
                </div>
                
                <div class="alert alert-info">
                  <i class="bi bi-lightbulb"></i>
                  <strong>Tips:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Tiêu đề nên ngắn gọn, hấp dẫn</li>
                    <li>Nội dung có thể sử dụng Markdown</li>
                    <li>Ảnh đại diện sẽ hiển thị ở trang chủ</li>
                  </ul>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Hủy
          </button>
          <button type="button" class="btn btn-primary" onclick="saveArticle()">
            <i class="bi bi-check-circle"></i> Lưu bài viết
          </button>
        </div>
      </div>
    </div>
  </div>


  </div>

  <script>
    // Kiểm tra phân quyền
    if (!localStorage.getItem("token") || localStorage.getItem("role") !== "Admin") {
      window.location.href = "user.html";
    }

    // Hiển thị tên đăng nhập & số dư
    window.onload = function () {
      const username = localStorage.getItem("username");
      const balance = localStorage.getItem("balance");
      
      if (username) {
        document.getElementById("username").textContent = username;
      }
      
      if (balance !== null) {
        document.getElementById("balance-display").textContent = `${Number(balance).toLocaleString()} ₫`;
      }
    };

    // Toggle dropdown
    function toggleDropdown() {
      const dropdown = document.getElementById("dropdownMenu");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    // Đóng dropdown khi click bên ngoài
    document.addEventListener("click", function(event) {
      const dropdown = document.getElementById("dropdownMenu");
      const userTrigger = document.querySelector(".user-trigger");
      
      if (!userTrigger.contains(event.target)) {
        dropdown.style.display = "none";
      }
    });

    // Logout
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("username");
      localStorage.removeItem("role");
      localStorage.removeItem("balance");
      window.location.href = "login.html";
    }

    // Load transaction history
    function loadTransactionHistory() {
      window.location.href = "lichsunap.html";
    }

    // Thêm bài viết mới
    function addNewArticle() {
      showArticleModal();
    }

    // Chỉnh sửa bài viết
    function editArticle(id) {
      console.log('✏️ Bắt đầu chỉnh sửa bài viết ID:', id);
      
      // Disable button và hiển thị loading
      const editBtn = document.querySelector(`[onclick="editArticle('${id}')"]`);
      const originalText = editBtn.innerHTML;
      editBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang tải...';
      editBtn.disabled = true;
      
      // Load bài viết
      loadArticleForEdit(id).finally(() => {
        // Restore button
        editBtn.innerHTML = originalText;
        editBtn.disabled = false;
      });
    }

    // Xóa bài viết
    function deleteArticle(id) {
      const articleTitle = document.querySelector(`[onclick="deleteArticle('${id}')"]`)
        .closest('.article-card')
        .querySelector('.article-title')
        .textContent.replace(/[📄📝]/g, '').trim();
      
      // Hiển thị modal xác nhận xóa
      showDeleteConfirmModal(id, articleTitle);
    }

    // Xem trước bài viết - Dùng popup modal
    async function previewArticle(id) {
      try {
        console.log('👁️ Xem trước bài viết ID:', id);
        
        const token = localStorage.getItem('token');
        if (!token) {
          alert('❌ Không có token đăng nhập. Vui lòng đăng nhập lại!');
          return;
        }
        
        // Tìm bài viết trong danh sách hiện tại
        const articles = await getCurrentArticles();
        const article = articles.find(a => a.id === id);
        
        if (!article) {
          console.error('❌ Không tìm thấy bài viết với ID:', id);
          alert('❌ Không tìm thấy bài viết để xem trước!');
          return;
        }
        
        console.log('📄 Tìm thấy bài viết để xem trước:', article.title);
        
        // Hiển thị modal xem trước với dữ liệu từ danh sách
        showPreviewModal(article);
        
      } catch (error) {
        console.error('❌ Preview fetch error:', error);
        alert('❌ Lỗi khi tải bài viết: ' + error.message);
      }
    }



    // Hiển thị modal thêm/sửa bài viết
    function showArticleModal(article = null) {
      const modal = new bootstrap.Modal(document.getElementById('articleModal'));
      const modalTitle = document.getElementById('modalTitle');
      const form = document.getElementById('articleForm');
      
      if (article) {
        modalTitle.textContent = 'Chỉnh sửa bài viết';
        // Điền dữ liệu vào form
        document.getElementById('articleTitle').value = article.title;
        document.getElementById('articleContent').value = article.content;
        document.getElementById('articleSummary').value = article.summary || '';
        document.getElementById('articleImage').value = article.image || '';
        document.getElementById('articleStatus').value = article.status || 'published';
        form.dataset.articleId = article.id;
      } else {
        modalTitle.textContent = 'Thêm bài viết mới';
        form.reset();
        delete form.dataset.articleId;
      }
      
      modal.show();
    }

    // Load bài viết để chỉnh sửa
    async function loadArticleForEdit(id) {
      try {
        console.log('✏️ Đang tải bài viết để chỉnh sửa ID:', id);
        
        const token = localStorage.getItem('token');
        if (!token) {
          alert('❌ Không có token đăng nhập. Vui lòng đăng nhập lại!');
          return;
        }
        
        // Tìm bài viết trong danh sách hiện tại
        const articles = await getCurrentArticles();
        const article = articles.find(a => a.id === id);
        
        if (!article) {
          console.error('❌ Không tìm thấy bài viết với ID:', id);
          alert('❌ Không tìm thấy bài viết để chỉnh sửa!');
          return;
        }
        
        console.log('📄 Tìm thấy bài viết để chỉnh sửa:', article.title);
        
        // Hiển thị modal với dữ liệu từ danh sách
        showArticleModal(article);
        
      } catch (error) {
        console.error('❌ Load article fetch error:', error);
        alert('❌ Lỗi kết nối: ' + error.message);
      }
    }

    // Xóa bài viết từ API
    async function deleteArticleFromAPI(id) {
      try {
        console.log('🗑️ Đang xóa bài viết ID:', id);
        
        const token = localStorage.getItem('token');
        if (!token) {
          alert('❌ Không có token đăng nhập. Vui lòng đăng nhập lại!');
          return;
        }
        
        // Tìm bài viết trong danh sách hiện tại để lấy ID đúng
        const articles = await getCurrentArticles();
        const article = articles.find(a => a.id === id);
        
        if (!article) {
          console.error('❌ Không tìm thấy bài viết với ID:', id);
          alert('❌ Không tìm thấy bài viết để xóa!');
          return;
        }
        
        console.log('📄 Tìm thấy bài viết:', article.title);
        
        const response = await fetch(`http://127.0.0.1:5000/api/articles/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('📋 Delete response status:', response.status);
        
        if (response.ok) {
          console.log('✅ Xóa bài viết thành công!');
          showDeleteSuccessModal();
          loadArticles(); // Reload danh sách
        } else {
          const error = await response.json();
          console.error('❌ Delete error:', error);
          showErrorModal('❌ Lỗi: ' + (error.message || 'Không thể xóa bài viết'));
        }
      } catch (error) {
        console.error('❌ Delete fetch error:', error);
        alert('❌ Lỗi kết nối: ' + error.message);
      }
    }

    // Lấy danh sách bài viết hiện tại
    async function getCurrentArticles() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://127.0.0.1:5000/api/articles', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          return data.articles || [];
        }
        return [];
      } catch (error) {
        console.error('❌ Lỗi lấy danh sách bài viết:', error);
        return [];
      }
    }

    // Lưu bài viết
    async function saveArticle() {
      const form = document.getElementById('articleForm');
      const formData = new FormData(form);
      
      const articleData = {
        title: formData.get('title'),
        content: formData.get('content'),
        summary: formData.get('summary'),
        image: formData.get('image'),
        status: formData.get('status')
      };
      
      console.log('📝 Article data:', articleData);
      
      if (!articleData.title || !articleData.content) {
        alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
        return;
      }
      
      try {
        // Nếu có file ảnh được chọn, upload trước
        if (window.selectedImageFile) {
          console.log('📤 Uploading image before saving article...');
          const imageResult = await uploadImage(window.selectedImageFile);
          if (imageResult) {
            articleData.image = imageResult.image_url;
            console.log('✅ Image uploaded:', imageResult.image_url);
          } else {
            console.log('❌ Upload image failed, using existing image');
          }
        }
        
        const articleId = form.dataset.articleId;
        const url = articleId ? 
          `http://127.0.0.1:5000/api/articles/${articleId}` : 
          'http://127.0.0.1:5000/api/articles';
        const method = articleId ? 'PUT' : 'POST';
        
        console.log('🌐 URL:', url);
        console.log('📋 Method:', method);
        console.log('📝 Final article data:', articleData);
        
        const token = localStorage.getItem('token');
        console.log('🔐 Token:', token ? 'Có token' : 'Không có token');
        
        // Tạo AbortController để timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
        
        try {
          const response = await fetch(url, {
            method: method,
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(articleData),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Request timeout - vui lòng thử lại');
          }
          throw error;
        }
        
        console.log('📋 Response status:', response.status);
        
        if (response.ok) {
          const result = await response.json();
          console.log('✅ Success result:', result);
          
          const successMessage = articleId ? 
            '✅ Cập nhật bài viết thành công!' : 
            '✅ Thêm bài viết thành công!';
          showSaveSuccessModal(successMessage);
          
          // Xóa file đã chọn
          window.selectedImageFile = null;
          
          // Đóng modal và reload danh sách
          const modal = bootstrap.Modal.getInstance(document.getElementById('articleModal'));
          modal.hide();
          
          // Reload danh sách sau khi lưu
          setTimeout(() => {
            loadArticles();
          }, 500);
        } else {
          const error = await response.json();
          console.error('❌ API Error:', error);
          showErrorModal('❌ Lỗi: ' + (error.error || 'Không thể lưu bài viết'));
        }
      } catch (error) {
        console.error('❌ Fetch error:', error);
        
        // Thử lại nếu là lỗi network
        if (error.message.includes('Failed to fetch') || error.message.includes('timeout')) {
          console.log('🔄 Thử lại lần 2...');
          try {
            const retryResponse = await fetch(url, {
              method: method,
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(articleData)
            });
            
            if (retryResponse.ok) {
              const result = await retryResponse.json();
              console.log('✅ Retry thành công:', result);
              
              const successMessage = articleId ? 
                '✅ Cập nhật bài viết thành công!' : 
                '✅ Thêm bài viết thành công!';
              showSaveSuccessModal(successMessage);
              
              // Xóa file đã chọn
              window.selectedImageFile = null;
              
              // Đóng modal và reload danh sách
              const modal = bootstrap.Modal.getInstance(document.getElementById('articleModal'));
              modal.hide();
              
              // Reload danh sách sau khi lưu
              setTimeout(() => {
                loadArticles();
              }, 500);
              return;
            }
          } catch (retryError) {
            console.error('❌ Retry cũng thất bại:', retryError);
          }
        }
        
        showErrorModal('Lỗi kết nối: ' + error.message);
      }
    }

    // Load articles from API
    async function loadArticles() {
      const loadingDiv = document.getElementById('loadingArticles');
      const articlesList = document.getElementById('articlesList');
      const noArticlesDiv = document.getElementById('noArticles');
      
      loadingDiv.style.display = 'block';
      articlesList.innerHTML = '';
      noArticlesDiv.style.display = 'none';
      
      try {
        const token = localStorage.getItem('token');
        console.log('🔐 Token:', token ? 'Có token' : 'Không có token');
        
        const response = await fetch('http://127.0.0.1:5000/api/articles', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('📋 Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          const articles = data.articles || [];
          console.log(`✅ Tải thành công ${articles.length} bài viết`);
          
          if (articles.length === 0) {
            noArticlesDiv.style.display = 'block';
            updateStats([]); // Cập nhật stats với mảng rỗng
          } else {
            displayArticles(articles);
          }
        } else {
          const errorData = await response.json();
          console.error('❌ API Error:', errorData);
        }
      } catch (error) {
        console.error('❌ Lỗi kết nối:', error);
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Display articles
    function displayArticles(articles) {
      const articlesList = document.getElementById('articlesList');
      
      articlesList.innerHTML = articles.map(article => `
        <div class="article-card">
          <div class="article-title">
            <i class="bi bi-newspaper me-2"></i>${article.title}
            ${article.status === 'draft' ? '<span class="badge bg-warning ms-2">Bản nháp</span>' : ''}
            ${article.status === 'archived' ? '<span class="badge bg-secondary ms-2">Đã lưu trữ</span>' : ''}
          </div>
          <div class="article-meta">
            <i class="bi bi-person me-1"></i>Đăng bởi <strong>${article.author}</strong> • 
            <i class="bi bi-calendar me-1"></i>${formatDate(article.created_at)} •
            <i class="bi bi-eye me-1"></i>${article.views} lượt xem
          </div>
          <div class="article-content">
            ${article.summary || article.content.substring(0, 200) + '...'}
          </div>
          <div class="article-actions">
            <button class="btn-edit" onclick="editArticle('${article.id}')">
              <i class="bi bi-pencil"></i>Chỉnh sửa
            </button>
            <button class="btn-delete" onclick="deleteArticle('${article.id}')">
              <i class="bi bi-trash"></i>Xóa
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="previewArticle('${article.id}')">
              <i class="bi bi-eye"></i>Xem trước
            </button>
          </div>
        </div>
      `).join('');
      
      // Update stats
      updateStats(articles);
    }

    // Update statistics
    function updateStats(articles) {
      const totalArticles = articles.length;
      const publishedArticles = articles.filter(a => a.status === 'published').length;
      const draftArticles = articles.filter(a => a.status === 'draft').length;
      const totalViews = articles.reduce((sum, a) => sum + (a.views || 0), 0);
      
      // Hiển thị 0 khi không có bài viết
      document.getElementById('totalArticles').textContent = totalArticles || 0;
      document.getElementById('publishedArticles').textContent = publishedArticles || 0;
      document.getElementById('draftArticles').textContent = draftArticles || 0;
      document.getElementById('totalViews').textContent = totalViews || 0;
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // Tìm kiếm bài viết
    document.getElementById("searchInput").addEventListener("input", function() {
      const searchTerm = this.value.toLowerCase();
      const articles = document.querySelectorAll(".article-card");
      
      articles.forEach(article => {
        const title = article.querySelector(".article-title").textContent.toLowerCase();
        const content = article.querySelector(".article-content").textContent.toLowerCase();
        
        if (title.includes(searchTerm) || content.includes(searchTerm)) {
          article.style.display = "block";
        } else {
          article.style.display = "none";
        }
      });
    });

    // Load articles on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadArticles();
    });

    // Lọc theo trạng thái
    document.getElementById("filterStatus").addEventListener("change", function() {
      const status = this.value;
      // Logic lọc sẽ được thêm sau
      console.log("Lọc theo trạng thái:", status);
    });

    // Xử lý chọn ảnh (chỉ preview, không upload ngay)
    document.getElementById("imageFile").addEventListener("change", function(e) {
      console.log('📸 File input change event triggered');
      
      // Ngăn chặn event propagation để không đóng modal
      e.preventDefault();
      e.stopPropagation();
      
      const file = e.target.files[0];
      if (file) {
        console.log('📸 File được chọn:', file.name);
        
        // Kiểm tra kích thước file (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('❌ File quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
          return;
        }
        
        // Kiểm tra loại file
        if (!file.type.startsWith('image/')) {
          alert('❌ Vui lòng chọn file ảnh!');
          return;
        }
        
        // Chỉ preview file, không upload ngay
        previewSelectedFile(file);
      }
    });

    // Debug: Kiểm tra modal có bị đóng không
    document.addEventListener('DOMContentLoaded', function() {
      const articleModal = document.getElementById('articleModal');
      if (articleModal) {
        articleModal.addEventListener('hidden.bs.modal', function () {
          console.log('🔍 Modal bị đóng!');
        });
        
        // Ngăn chặn modal đóng khi click bên trong
        articleModal.addEventListener('click', function(e) {
          if (e.target === articleModal) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        });
      }
      
      // Thêm event listener cho button upload
      const uploadBtn = document.getElementById('uploadBtn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('📤 Upload button clicked');
          document.getElementById('imageFile').click();
        });
      }
    });

    // Preview file được chọn (không upload)
    function previewSelectedFile(file) {
      console.log('🖼️ Preview file:', file.name);
      
      // Tạo URL để preview
      const fileUrl = URL.createObjectURL(file);
      
      // Hiển thị preview
      showImagePreview(fileUrl);
      
      // Lưu file vào biến global để upload sau
      window.selectedImageFile = file;
      
      // Hiển thị thông báo
      showFileSelectedMessage(file.name);
    }

    // Upload ảnh lên server
    async function uploadImage(file) {
      try {
        console.log('📤 Đang upload ảnh...');
        
        const formData = new FormData();
        formData.append('image', file);
        
        const token = localStorage.getItem('token');
        const response = await fetch('http://127.0.0.1:5000/api/upload-image', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('✅ Upload thành công:', result);
          
          // Cập nhật input và preview
          document.getElementById('articleImage').value = result.image_url;
          showImagePreview(result.image_url);
          
          // Hiển thị thông báo thành công nhỏ
          showUploadSuccess();
          
          // Trả về kết quả để sử dụng trong saveArticle
          return result;
          
        } else {
          const error = await response.json();
          console.error('❌ Upload thất bại:', error);
          alert('❌ Upload thất bại: ' + (error.message || 'Lỗi không xác định'));
          return null;
        }
        
      } catch (error) {
        console.error('❌ Lỗi upload:', error);
        alert('❌ Lỗi upload: ' + error.message);
        return null;
      }
    }

    // Hiển thị thông báo file được chọn
    function showFileSelectedMessage(fileName) {
      // Tạo thông báo nhỏ
      const messageDiv = document.createElement('div');
      messageDiv.className = 'alert alert-info alert-dismissible fade show';
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.zIndex = '9999';
      messageDiv.innerHTML = `
        <i class="bi bi-image"></i> Đã chọn: ${fileName}
        <br><small>Ảnh sẽ được upload khi lưu bài viết</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(messageDiv);
      
      // Tự động ẩn sau 5 giây
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }

    // Hiển thị thông báo upload thành công
    function showUploadSuccess() {
      // Tạo thông báo nhỏ thay vì alert
      const successDiv = document.createElement('div');
      successDiv.className = 'alert alert-success alert-dismissible fade show';
      successDiv.style.position = 'fixed';
      successDiv.style.top = '20px';
      successDiv.style.right = '20px';
      successDiv.style.zIndex = '9999';
      successDiv.innerHTML = `
        <i class="bi bi-check-circle"></i> Upload ảnh thành công!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(successDiv);
      
      // Tự động ẩn sau 3 giây
      setTimeout(() => {
        if (successDiv.parentNode) {
          successDiv.remove();
        }
      }, 3000);
    }

    // Hiển thị modal thành công khi xóa bài viết
    function showDeleteSuccessModal() {
      const modalHTML = `
        <div class="modal fade" id="deleteSuccessModal" tabindex="-1" aria-labelledby="deleteSuccessModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="deleteSuccessModalLabel">
                  <i class="bi bi-check-circle"></i> Thành công!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Xóa bài viết thành công!</h5>
                <p class="text-muted">Bài viết đã được xóa khỏi hệ thống.</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                  <i class="bi bi-check"></i> OK
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Xóa modal cũ nếu có
      const oldModal = document.getElementById('deleteSuccessModal');
      if (oldModal) {
        oldModal.remove();
      }
      
      // Thêm modal mới
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Hiển thị modal
      const modal = new bootstrap.Modal(document.getElementById('deleteSuccessModal'));
      modal.show();
      
      // Tự động đóng sau 3 giây
      setTimeout(() => {
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('deleteSuccessModal'));
        if (modalInstance) {
          modalInstance.hide();
        }
      }, 3000);
    }

    // Hiển thị modal lỗi
    function showErrorModal(message) {
      const modalHTML = `
        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel">
                  <i class="bi bi-exclamation-triangle"></i> Lỗi!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Có lỗi xảy ra!</h5>
                <p class="text-muted">${message}</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle"></i> Đóng
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Xóa modal cũ nếu có
      const oldModal = document.getElementById('errorModal');
      if (oldModal) {
        oldModal.remove();
      }
      
      // Thêm modal mới
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Hiển thị modal
      const modal = new bootstrap.Modal(document.getElementById('errorModal'));
      modal.show();
    }

    // Hiển thị modal thành công khi lưu bài viết
    function showSaveSuccessModal(message) {
      const modalHTML = `
        <div class="modal fade" id="saveSuccessModal" tabindex="-1" aria-labelledby="saveSuccessModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="saveSuccessModalLabel">
                  <i class="bi bi-check-circle"></i> Thành công!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">${message}</h5>
                <p class="text-muted">Bài viết đã được lưu thành công vào hệ thống.</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                  <i class="bi bi-check"></i> OK
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Xóa modal cũ nếu có
      const oldModal = document.getElementById('saveSuccessModal');
      if (oldModal) {
        oldModal.remove();
      }
      
      // Thêm modal mới
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Hiển thị modal
      const modal = new bootstrap.Modal(document.getElementById('saveSuccessModal'));
      modal.show();
      
      // Tự động đóng sau 3 giây
      setTimeout(() => {
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('saveSuccessModal'));
        if (modalInstance) {
          modalInstance.hide();
        }
      }, 3000);
    }

    // Hiển thị preview ảnh
    function showImagePreview(imageUrl) {
      const preview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      
      previewImg.src = imageUrl;
      preview.style.display = 'block';
    }

    // Hiển thị modal xác nhận xóa
    function showDeleteConfirmModal(articleId, articleTitle) {
      console.log('🗑️ Hiển thị modal xác nhận xóa:', articleTitle);
      
      const modalTitle = document.getElementById('deleteConfirmModalLabel');
      const modalBody = document.getElementById('deleteConfirmModalBody');
      const confirmBtn = document.getElementById('deleteConfirmBtn');
      
      // Cập nhật nội dung modal
      modalTitle.textContent = 'Xác nhận xóa bài viết';
      modalBody.innerHTML = `
        <div class="text-center">
          <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
          <h5 class="mt-3">Bạn có chắc chắn muốn xóa bài viết?</h5>
          <p class="text-muted">"${articleTitle}"</p>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Hành động này không thể hoàn tác!</strong>
          </div>
        </div>
      `;
      
      // Cập nhật button xác nhận
      confirmBtn.onclick = function() {
        console.log('🗑️ User confirmed delete for article ID:', articleId);
        deleteArticleFromAPI(articleId);
        
        // Đóng modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        modal.hide();
      };
      
      // Hiển thị modal
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      deleteModal.show();
    }

    // Hiển thị modal xem trước bài viết
    function showPreviewModal(article) {
      console.log('🎬 Hiển thị popup xem trước:', article.title);
      
      const modalTitle = document.getElementById('previewModalLabel');
      const modalContent = document.getElementById('previewModalContent');
      
      // Cập nhật tiêu đề modal
      modalTitle.textContent = `Xem Trước: ${article.title}`;
      
      // Tạo nội dung xem trước
      const previewHTML = `
        <div class="article-preview">
          <div class="row">
            <div class="col-md-8">
              <h2 class="mb-3">${article.title}</h2>
              <div class="article-meta mb-4">
                <span class="badge bg-primary me-2">${article.status === 'published' ? 'Đã xuất bản' : 'Bản nháp'}</span>
                <small class="text-muted">
                  <i class="bi bi-person me-1"></i>${article.author} • 
                  <i class="bi bi-calendar me-1"></i>${formatDate(article.created_at)} • 
                  <i class="bi bi-eye me-1"></i>${article.views || 0} lượt xem
                </small>
              </div>
              ${article.image ? `<img src="${article.image}" class="img-fluid mb-4" alt="${article.title}">` : ''}
              <div class="article-summary mb-4">
                <h5>Tóm tắt:</h5>
                <p class="text-muted">${article.summary || 'Không có tóm tắt'}</p>
              </div>
              <div class="article-content">
                <h5>Nội dung:</h5>
                <div class="content-preview" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                  ${article.content.replace(/\n/g, '<br>')}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Thông tin bài viết</h6>
                </div>
                <div class="card-body">
                  <p><strong>ID:</strong> ${article.id}</p>
                  <p><strong>Trạng thái:</strong> 
                    <span class="badge ${article.status === 'published' ? 'bg-success' : 'bg-warning'}">
                      ${article.status === 'published' ? 'Đã xuất bản' : 'Bản nháp'}
                    </span>
                  </p>
                  <p><strong>Ngày tạo:</strong> ${formatDate(article.created_at)}</p>
                  <p><strong>Lượt xem:</strong> ${article.views || 0}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      modalContent.innerHTML = previewHTML;
      
      // Hiển thị modal
      const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
      previewModal.show();
    }
  </script>

  <!-- Modal xem trước bài viết -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">Xem Trước Bài Viết</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="previewModalContent">
            <!-- Nội dung xem trước sẽ được thêm vào đây -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xác nhận xóa bài viết -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteConfirmModalLabel">
            <i class="bi bi-exclamation-triangle"></i> Xác nhận xóa bài viết
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="deleteConfirmModalBody">
          <!-- Nội dung xác nhận sẽ được thêm vào đây -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Hủy
          </button>
          <button type="button" class="btn btn-danger" id="deleteConfirmBtn">
            <i class="bi bi-trash"></i> Xóa bài viết
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
