<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nạp Thẻ Cào - WUANG VINH</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background: #f8f9fa;
      overflow-x: hidden;
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 250px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 0;
      z-index: 1000;
    }
    
    .sidebar .logo {
      display: block;
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin: 0 15px 30px 15px;
      text-decoration: none;
    }
    
    .sidebar a {
      display: block;
      padding: 12px 25px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    
    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left-color: #fff;
    }
    .main-content {
      margin-left: 250px;
      padding: 30px;
      background: #f8f9fa;
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      position: relative;
      min-height: 80px;
      display: flex;
      align-items: center;
    }
    .header .d-flex {
      width: 100%;
      position: relative;
    }
    /* Force dropdown to absolute right */
    .header .dropdown {
      position: absolute !important;
      right: 20px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      z-index: 1000;
    }
    .header .dropdown-menu {
      right: 0 !important;
      left: auto !important;
      min-width: 200px;
    }
    .header .dropdown button {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    .footer {
      background: #343a40;
      color: white;
      text-align: center;
      padding: 1rem;
      margin-top: auto;
    }
    .highlight {
      color: #ffc107;
    }
  </style>
</head>
<body style="background-color: #f8f9fa; overflow-x: hidden;">
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="user.html" class="logo">
      <h3 class="text-white mb-0 fw-bold">
        <i class="bi bi-code-slash me-2"></i>
        WUANG VINH
      </h3>
    </a>
    <a href="user.html">
      <i class="bi bi-house me-2"></i>Trang Chủ
    </a>
    <a href="sanpham.html">
      <i class="bi bi-box me-2"></i>Sản Phẩm
    </a>
    <a href="lichsumuahang.html">
      <i class="bi bi-clock-history me-2"></i>Lịch Sử Mua Hàng
    </a>
    <a href="napthe.html" class="active">
      <i class="bi bi-credit-card me-2"></i>Nạp Thẻ Cào
    </a>
    <a href="vidientu.html">
      <i class="bi bi-wallet2 me-2"></i>Ví Điện Tử
    </a>
    <a href="baiviet_action.html">
      <i class="bi bi-file-text me-2"></i>Bài Viết
    </a>
    <a href="lienhe.html">
      <i class="bi bi-envelope me-2"></i>Liên Hệ
    </a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="mb-0">
            <i class="bi bi-credit-card text-primary"></i>
            Nạp Thẻ Cào
          </h1>
          <p class="text-muted mb-0">Nạp tiền vào tài khoản bằng thẻ cào điện thoại</p>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle me-2"></i>
            <span id="username">Chưa đăng nhập</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li><div class="dropdown-item-text">
              <i class="bi bi-wallet me-2"></i>Số dư: <span id="userBalance">0 ₫</span>
            </div></li>
            <li><a class="dropdown-item" href="#" onclick="showBalanceHistory()">
              <i class="bi bi-graph-up me-2"></i>Biến động số dư
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="showActivityHistory()">
              <i class="bi bi-clock-history me-2"></i>Lịch sử hoạt động
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
              <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
            </a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Nội dung chính sẽ ở đây -->
      <div id="transaction-history-container" class="transaction-history-container">
        <!-- Lịch sử giao dịch sẽ được thêm ở đây -->
      </div>
      <!-- Form nạp thẻ -->
      <div class="container mt-4">
        <div class="row justify-content-center">
          <div class="col-md-10 col-lg-8">
            <div class="card shadow-lg rounded-4 border-0 mb-4">
              <div class="card-header bg-primary text-white rounded-top-4">
                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Nạp Thẻ Cào</h5>
              </div>
              <div class="card-body">
                <form id="card-topup-form">
                  <div class="mb-3">
                    <label for="cardType" class="form-label">
                      <i class="bi bi-phone me-2"></i>Loại thẻ
                    </label>
                    <select class="form-select" id="cardType" required>
                      <option value="">Chọn loại thẻ</option>
                      <option value="Viettel">Viettel</option>
                      <option value="Mobifone">Mobifone</option>
                      <option value="Vinaphone">Vinaphone</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="amount" class="form-label">
                      <i class="bi bi-cash-coin me-2"></i>Mệnh giá
                    </label>
                    <select class="form-select" id="amount" required>
                      <option value="">Chọn mệnh giá</option>
                      <option value="10000">10.000đ</option>
                      <option value="20000">20.000đ</option>
                      <option value="50000">50.000đ</option>
                      <option value="100000">100.000đ</option>
                      <option value="200000">200.000đ</option>
                      <option value="500000">500.000đ</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="serial" class="form-label">
                      <i class="bi bi-upc-scan me-2"></i>Số Seri
                    </label>
                    <input type="text" class="form-control" id="serial" required>
                  </div>
                  <div class="mb-3">
                    <label for="code" class="form-label">
                      <i class="bi bi-key me-2"></i>Mã Thẻ
                    </label>
                    <input type="text" class="form-control" id="code" required>
                  </div>
                  <button type="submit" class="btn btn-success w-100 fw-bold">
                    <i class="bi bi-check-circle me-2"></i>Nạp thẻ
                  </button>
                  <div id="topup-result" class="mt-3"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lịch sử nạp thẻ -->
      <div class="container mt-4">
        <div class="row justify-content-center">
          <div class="col-md-10 col-lg-8">
            <div class="card shadow-lg rounded-4 border-0">
              <div class="card-header bg-primary text-white rounded-top-4">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Lịch sử nạp thẻ</h5>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle mb-0 rounded-4 overflow-hidden" id="card-history-table">
                    <thead class="table-primary">
                      <tr>
                        <th class="text-center"><i class="bi bi-hash me-1"></i>STT</th>
                        <th class="text-center"><i class="bi bi-upc-scan me-1"></i>Seri</th>
                        <th class="text-center"><i class="bi bi-key me-1"></i>Mã thẻ</th>
                        <th class="text-center"><i class="bi bi-cash-coin me-1"></i>Mệnh giá</th>
                        <th class="text-center"><i class="bi bi-info-circle me-1"></i>Trạng thái</th>
                      </tr>
                    </thead>
                    <tbody id="card-history-body">
                      <!-- Dữ liệu sẽ được render bằng JS, mỗi trạng thái sẽ có badge màu -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  

  <!-- Scripts -->
  <script>
    // User management functions
    function updateUserInfo() {
      const token = localStorage.getItem("token");
      const username = localStorage.getItem("username");
      const role = localStorage.getItem("role");
      const balance = localStorage.getItem("balance");

      if (token && username) {
        // Update username and balance
        const usernameElement = document.getElementById("username");
        const balanceElement = document.getElementById("userBalance");
        
        if (usernameElement) {
          usernameElement.textContent = username;
        }
        
        if (balance && balanceElement) {
          const formattedBalance = Number(balance).toLocaleString();
          balanceElement.textContent = `${formattedBalance} ₫`;
        }
        
        // Update balance from server
        updateBalanceFromDB(username);
      }
      // Don't redirect automatically - let user stay on page
    }

    // Update balance from database
    async function updateBalanceFromDB(username) {
      const token = localStorage.getItem("token");
      if (!token || !username) return;

      try {
        const response = await fetch(`http://localhost:5000/api/user/${username}/balance`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem("balance", data.balance);
          const formattedBalance = Number(data.balance).toLocaleString();
          document.getElementById("userBalance").textContent = `${formattedBalance} ₫`;
        }
      } catch (error) {
        console.error("Lỗi kết nối API:", error);
      }
    }

    // Show balance history
    function showBalanceHistory() {
      const username = localStorage.getItem("username");
      if (!username) {
        alert("Vui lòng đăng nhập để xem lịch sử!");
        return;
      }
      loadTransactionHistory();
    }

    // Show activity history
    function showActivityHistory() {
      const username = localStorage.getItem("username");
      if (!username) {
        alert("Vui lòng đăng nhập để xem lịch sử!");
        return;
      }
      window.location.href = "lichsumuahang.html";
    }

    // Logout function
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("username");
      localStorage.removeItem("role");
      localStorage.removeItem("balance");
      localStorage.removeItem("user_id");
      localStorage.removeItem("email");
      sessionStorage.clear();
      window.location.href = "login.html";
    }

    // Initialize on page load
    window.onload = function() {
      console.log("Page loaded");
      
      // Stabilize layout
      document.body.style.overflowX = 'hidden';
      
      // Update user info
      updateUserInfo();
      
      // Update balance every 30 seconds
      setInterval(() => {
        const username = localStorage.getItem("username");
        if (username) {
          updateBalanceFromDB(username);
        }
      }, 30000);
    };



    // Load transaction history
    function loadTransactionHistory() {
      console.log("Loading transaction history");
      const username = localStorage.getItem("username");
      if (!username) {
        alert("Không tìm thấy tên người dùng.");
        return;
      }

      const token = localStorage.getItem("token");

      fetch(`http://localhost:5000/api/user/${username}/transactions`, {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token,
        }
      })
      .then(response => response.json())
      .then(transactions => {
        console.log("Transaction history loaded:", transactions);
        if (transactions.length === 0) {
          alert("Không có giao dịch nào.");
          return;
        }
        displayTransactionHistory(transactions);
      })
      .catch(err => {
        console.error(err);
        alert("Không thể tải lịch sử giao dịch.");
      });
    }

    // Display transaction history
    function displayTransactionHistory(transactions) {
      console.log("Displaying transaction history");
      const transactionContainer = document.getElementById("transaction-history-container");
      transactionContainer.innerHTML = "";

      transactions.forEach(transaction => {
        const transactionElement = document.createElement("div");
        transactionElement.classList.add("transaction-item", "card", "mb-3");

        transactionElement.innerHTML = `
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <strong>Loại giao dịch:</strong> ${transaction.transactionType === 'add' ? 'Nạp tiền' : 'Rút tiền'}
              </div>
              <div class="col-md-3">
                <strong>Số tiền:</strong> ${transaction.amount} đ
              </div>
              <div class="col-md-3">
                <strong>Admin thực hiện:</strong> ${transaction.adminId.username}
              </div>
              <div class="col-md-3">
                <strong>Thời gian:</strong> ${new Date(transaction.createdAt).toLocaleString()}
              </div>
            </div>
          </div>
        `;
        
        transactionContainer.appendChild(transactionElement);
      });
    }

    let cardHistory = [];
    
    async function fetchCardHistory() {
      const token = localStorage.getItem("token");
      if (!token) return;
      
      try {
        const res = await fetch('http://localhost:5000/api/topup-card/history', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          cardHistory = await res.json();
          renderCardHistory(cardHistory); // Pass the fetched history to render
        }
      } catch (error) {
        console.error("Lỗi khi tải lịch sử nạp thẻ:", error);
      }
    }
    
    function renderCardHistory(history) {
      const tbody = document.getElementById('card-history-body');
      tbody.innerHTML = '';
      if (!history || history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Chưa có lịch sử nạp thẻ</td></tr>';
        return;
      }
      history.forEach((item, idx) => {
        let badge = '';
        let icon = '';
        if(item.status === 'Thành công') {
          badge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Thành công</span>';
        } else if(item.status === 'Đang nạp' || item.status === 'Đang duyệt' || item.status === 'Chờ xử lý') {
          badge = '<span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Đang nạp</span>';
        } else {
          badge = '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Thất bại</span>';
        }
        let created = item.created_at ? new Date(item.created_at).toLocaleString('vi-VN') : '';
        tbody.innerHTML += `
          <tr>
            <td class="text-center">${idx+1}</td>
            <td class="text-center"><code>${item.serial||''}</code></td>
            <td class="text-center"><code>${item.code||''}</code></td>
            <td class="text-center"><strong>${Number(item.amount||0).toLocaleString()} đ</strong></td>
            <td class="text-center">${badge}</td>
            <td class="text-center text-muted" style="font-size:12px">${created}</td>
          </tr>
        `;
      });
    }
    
    // Initialize card history on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM loaded, fetching card history");
      
      // Stabilize layout
      document.body.style.overflowX = 'hidden';
      
      fetchCardHistory();
    });
    
    // Handle card topup form submission
    document.getElementById('card-topup-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const cardType = document.getElementById('cardType').value;
      const amount = document.getElementById('amount').value;
      const serial = document.getElementById('serial').value;
      const code = document.getElementById('code').value;
      
      if (!cardType || !amount || !serial || !code) {
        alert("Vui lòng điền đầy đủ thông tin!");
        return;
      }
      
      const resultDiv = document.getElementById('topup-result');
      resultDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split me-2"></i>Đang xử lý...</div>';
      
      const token = localStorage.getItem("token");
      if (!token) {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Vui lòng đăng nhập!</div>';
        return;
      }
      
      try {
        const res = await fetch('http://localhost:5000/api/topup-card', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ cardType, amount, serial, code })
        });
        const data = await res.json();
        if (res.ok && data.success) {
          resultDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Nạp thẻ thành công! Đang nạp...</div>';
          // Hiển thị ngay dòng mới trong lịch sử với trạng thái Đang nạp
          const tbody = document.getElementById('card-history-body');
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td class="text-center">?</td>
            <td class="text-center">${serial}</td>
            <td class="text-center">${code}</td>
            <td class="text-center">${amount} đ</td>
            <td class="text-center"><span class="badge badge-warning">Đang nạp</span></td>
          `;
          tbody.prepend(newRow);
          // Lấy id giao dịch vừa tạo (giả sử backend trả về topupId)
          const topupId = data.topupId || data.id || data._id;
          // Sau 5 giây chuyển trạng thái thành công
          setTimeout(async () => {
            if (topupId) {
              await fetch(`http://localhost:5000/api/topup-card/${topupId}/status`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ status: 'Thành công' })
              });
            }
            resultDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Nạp thẻ thành công! Tiền đã được cộng vào tài khoản.</div>';
            fetchCardHistory();
            const username = localStorage.getItem("username");
            if (username) updateBalanceFromDB(username);
          }, 5000);
          // Clear form
          document.getElementById('card-topup-form').reset();
        } else {
          resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>'+(data.message||'Nạp thẻ thất bại!')+'</div>';
        }
      } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>Lỗi kết nối server!</div>';
      }
    });

  </script>
</body>
</html>
