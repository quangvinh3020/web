<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cấu Hình Ngân Hàng</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Admin Common CSS -->
  <link href="css/admin-common.css" rel="stylesheet">
  <style>
    .bank-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
    }
    
    .settings-form {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .qr-preview {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 2px dashed #dee2e6;
    }
    
    .qr-preview img {
      max-width: 200px;
      height: auto;
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .file-input-wrapper .btn {
      width: 100%;
      padding: 12px 15px;
      border: 2px dashed #dee2e6;
      background: #f8f9fa;
      color: #6c757d;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .file-input-wrapper .btn:hover {
      border-color: #667eea;
      background: #f0f2ff;
      color: #667eea;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="admin.html" class="logo">
      <h3 class="text-white mb-0 fw-bold">
        <i class="bi bi-code-slash me-2"></i>
        WUANG VINH
      </h3>
      <small class="text-white-50">ADMIN PANEL</small>
    </a>
    <a href="quanlidanhmuc.html">
      <i class="bi bi-list-ul me-2"></i>Quản lí danh mục
    </a>
    <a href="src.html">
      <i class="bi bi-file-earmark-code me-2"></i>Mã Nguồn
    </a>
    <a href="atm.html" class="active">
      <i class="bi bi-bank me-2"></i>Ngân hàng
    </a>
    <a href="customer.html">
      <i class="bi bi-people me-2"></i>Khách hàng
    </a>
    <a href="lichsunap.html">
      <i class="bi bi-clock-history me-2"></i>Lịch sử nạp tiền
    </a>
    <a href="baiviet.html">
      <i class="bi bi-file-text me-2"></i>Bài Viết
    </a>
    <a href="settingadmin.html">
      <i class="bi bi-gear me-2"></i>Cấu hình
    </a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="content-header">
      <div class="row align-items-center">
        <div class="col">
          <h1 class="mb-0">
            <i class="bi bi-bank text-primary"></i>
            Cấu Hình Ngân Hàng
          </h1>
          <p class="text-muted mb-0">Thiết lập thông tin chuyển khoản cho người dùng</p>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" onclick="window.location.href='vidientu.html'">
            <i class="bi bi-eye"></i> Xem Trang Người Dùng
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="row">
      <div class="col-lg-8">
        <div class="settings-form">
          <h4 class="mb-4">
            <i class="bi bi-gear me-2"></i>Thông Tin Chuyển Khoản
          </h4>
          
          <form id="bank-settings-form">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-4">
                  <label for="bankName" class="form-label">
                    <i class="bi bi-bank me-2"></i>Tên ngân hàng
                  </label>
                  <input type="text" class="form-control" id="bankName" name="bankName" 
                         placeholder="VD: Vietcombank, BIDV..." required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-4">
                  <label for="accountNumber" class="form-label">
                    <i class="bi bi-credit-card me-2"></i>Số tài khoản
                  </label>
                  <input type="text" class="form-control" id="accountNumber" name="accountNumber" 
                         placeholder="Nhập số tài khoản..." required>
                </div>
              </div>
            </div>
            
            <div class="mb-4">
              <label for="accountName" class="form-label">
                <i class="bi bi-person me-2"></i>Tên chủ tài khoản
              </label>
              <input type="text" class="form-control" id="accountName" name="accountName" 
                     placeholder="Nhập tên chủ tài khoản..." required>
            </div>
            
            <div class="mb-4">
              <label for="transferContent" class="form-label">
                <i class="bi bi-chat-text me-2"></i>Nội dung chuyển khoản
              </label>
              <input type="text" class="form-control" id="transferContent" name="transferContent" 
                     placeholder="VD: wuangvinh + username..." required>
              <small class="text-muted">Nội dung này sẽ hiển thị cho người dùng khi nạp tiền</small>
            </div>
            
            <div class="mb-4">
              <label for="qrImage" class="form-label">
                <i class="bi bi-qr-code me-2"></i>Ảnh mã QR
              </label>
              <div class="file-input-wrapper">
                <label class="btn btn-outline-secondary" for="qrImage">
                  <i class="bi bi-upload"></i> Chọn ảnh QR...
                </label>
                <input type="file" id="qrImage" accept="image/*" style="display: none;">
              </div>
              <small class="text-muted">Upload ảnh mã QR để người dùng quét</small>
            </div>
            
            <div class="mb-4">
              <label for="transferNote" class="form-label">
                <i class="bi bi-info-circle me-2"></i>Ghi chú
              </label>
              <textarea class="form-control" id="transferNote" name="transferNote" rows="3" 
                        placeholder="Ghi chú thêm cho người dùng..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg w-100">
              <i class="bi bi-check-circle me-2"></i>Lưu Cấu Hình
            </button>
          </form>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="bank-card">
          <h5 class="mb-3">
            <i class="bi bi-info-circle me-2"></i>Hướng Dẫn
          </h5>
          <ul class="list-unstyled">
            <li class="mb-2">
              <i class="bi bi-check-circle me-2"></i>Nhập thông tin ngân hàng
            </li>
            <li class="mb-2">
              <i class="bi bi-check-circle me-2"></i>Upload ảnh mã QR
            </li>
            <li class="mb-2">
              <i class="bi bi-check-circle me-2"></i>Lưu cấu hình
            </li>
            <li class="mb-2">
              <i class="bi bi-check-circle me-2"></i>Thông tin sẽ hiển thị trong nạp ví điện tử
            </li>
          </ul>
          
          <div class="mt-4">
            <h6 class="mb-2">
              <i class="bi bi-eye me-2"></i>Xem Trước
            </h6>
            <div class="qr-preview" id="qrPreview">
              <i class="bi bi-qr-code" style="font-size: 3rem; color: #6c757d;"></i>
              <p class="mt-2 mb-0 text-muted">Chưa có ảnh QR</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Function hiển thị thông báo
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // Xử lý upload ảnh QR
    document.getElementById('qrImage').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const preview = document.getElementById('qrPreview');
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <img src="${e.target.result}" alt="QR Code" class="img-fluid">
            <p class="mt-2 mb-0 text-muted">${file.name}</p>
          `;
        };
        reader.readAsDataURL(file);
      }
    });

    // Xử lý form cấu hình
    document.getElementById('bank-settings-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('bankName', document.getElementById('bankName').value);
      formData.append('accountNumber', document.getElementById('accountNumber').value);
      formData.append('accountName', document.getElementById('accountName').value);
      formData.append('transferContent', document.getElementById('transferContent').value);
      formData.append('transferNote', document.getElementById('transferNote').value);
      
      const qrFile = document.getElementById('qrImage').files[0];
      if (qrFile) {
        formData.append('qrImage', qrFile);
      }
      
      try {
        const res = await fetch('http://localhost:5000/api/bank/settings', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        
        if (res.ok) {
          showAlert('Lưu cấu hình thành công!', 'success');
          // Reset form
          document.getElementById('bank-settings-form').reset();
          document.getElementById('qrPreview').innerHTML = `
            <i class="bi bi-qr-code" style="font-size: 3rem; color: #6c757d;"></i>
            <p class="mt-2 mb-0 text-muted">Chưa có ảnh QR</p>
          `;
        } else {
          showAlert(data.message || 'Có lỗi xảy ra!', 'danger');
        }
      } catch (err) {
        showAlert('Lỗi kết nối server!', 'danger');
      }
    });

    // Load cấu hình hiện tại
    async function loadCurrentSettings() {
      try {
        const res = await fetch('http://localhost:5000/api/bank/settings');
        const data = await res.json();
        
        if (res.ok && data.settings) {
          document.getElementById('bankName').value = data.settings.bankName || '';
          document.getElementById('accountNumber').value = data.settings.accountNumber || '';
          document.getElementById('accountName').value = data.settings.accountName || '';
          document.getElementById('transferContent').value = data.settings.transferContent || '';
          document.getElementById('transferNote').value = data.settings.transferNote || '';
          
          if (data.settings.qrImage) {
            document.getElementById('qrPreview').innerHTML = `
              <img src="${data.settings.qrImage}" alt="QR Code" class="img-fluid">
              <p class="mt-2 mb-0 text-muted">QR Code hiện tại</p>
            `;
          }
        }
      } catch (err) {
        console.log('Không thể load cấu hình hiện tại');
      }
    }

    // Load cấu hình khi trang load
    document.addEventListener('DOMContentLoaded', loadCurrentSettings);
  </script>

</body>
</html>
